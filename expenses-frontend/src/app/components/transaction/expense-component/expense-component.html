<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h3 class="mb-0">–í–∏—Ç—Ä–∞—Ç–∏</h3>
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <input type="date" class="form-control" style="width: 170px"
             [ngModel]="from" (ngModelChange)="onFrom($event)" />
      <input type="date" class="form-control" style="width: 170px"
             [ngModel]="to" (ngModelChange)="onTo($event)" />
      <input type="month" class="form-control" style="width: 170px"
             [ngModel]="month" (ngModelChange)="onMonth($event)" />
      <input type="text" class="form-control" style="width: 220px" placeholder="–ü–æ—à—É–∫..."
             [ngModel]="search" (ngModelChange)="onSearch($event)" />
      <button class="btn btn-success" (click)="openCreate()">+ –î–æ–¥–∞—Ç–∏</button>
    </div>
  </div>

  @if (loading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary"></div>
    </div>
  } @else if (errorMessage) {
    <div class="alert alert-danger">{{ errorMessage }}</div>
  } @else {

    <div class="card mb-3">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>–ó–Ω–∞–π–¥–µ–Ω–æ: <b>{{ view.length }}</b></div>
        <div>–°—É–º–∞: <b class="fw-semibold text-danger">-{{ total | currency:' UAH ' }}</b></div>
      </div>
    </div>

    <div class="table-responsive shadow-sm rounded mb-3">
      <table class="table custom-table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th (click)="onSort('date')" style="cursor:pointer">
              –î–∞—Ç–∞ 
              @if (sortKey==='date') {
                <span class="ms-1">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span>
              }
            </th>
            <th (click)="onSort('category')" style="cursor:pointer">
              –ö–∞—Ç–µ–≥–æ—Ä—ñ—è 
              @if (sortKey==='category') {
                <span class="ms-1">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span>
              }
            </th>
            <th (click)="onSort('description')" style="cursor:pointer">
              –û–ø–∏—Å 
              @if (sortKey==='description') {
                <span class="ms-1">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span>
              }
            </th>
            <th class="text-end" (click)="onSort('amount')" style="cursor:pointer">
              –°—É–º–∞ 
              @if (sortKey==='amount') {
                <span class="ms-1">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span>
              }
            </th>
            <th class="text-center">–î—ñ—ó</th>
          </tr>
        </thead>
        <tbody>
          @for (t of view; track t.id) {
            <tr>
              <td>{{ t.date | date:'dd.MM.yyyy' }}</td>
              <td><span class="badge text-bg-secondary">{{ t.categoryName }}</span></td>
              <td>{{ t.description }}</td>
              <td class="text-end fw-bold text-danger">-{{ t.amount | currency:'UAH ':'symbol':'1.2-2' }}</td>
              <td class="text-center">
                <button class="btn btn-sm btn-primary btn-action me-2" (click)="openEdit(t)" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è
                  <span class="bi bi-pencil-square fs-5 text-primary"></span>
                </button>
                <button class="btn btn-sm btn-danger btn-action" (click)="confirmDelete(t)" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è
                  <span class="bi bi-trash fs-5 text-danger"></span>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header">–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</div>
          <div class="card-body">
            <app-pie-chart-component [data]="pieData"></app-pie-chart-component>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-header">–î–∏–Ω–∞–º—ñ–∫–∞ –∑–∞ –º—ñ—Å—è—Ü—è–º–∏</div>
          <div class="card-body">
            <app-bar-chart-component [data]="seriesData" [xFmt]="formatMonthLabel"></app-bar-chart-component>
          </div>
        </div>
      </div>
    </div>
  }

  <app-transaction-form-modal
    [visible]="modalVisible"
    [transaction]="editing"
    [presetType]="'EXPENSE'"
    (close)="onCloseModal()"
    (save)="save($event)">
  </app-transaction-form-modal>
</div>
